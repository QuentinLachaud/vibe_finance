import{r as i,j as e,f as b,u as Ye,b as He,c as W,a as Ue,d as Xe,e as oe,g as Je,L as Ze}from"./index-bqMAKIKc.js";import{f as q,c as P,r as Qe,g as Me}from"./simulationEngine-DmQAKyWZ.js";import{A as es,D as ss,af as as,ao as ts,ap as ns,aq as ls,ar as rs,G as te,as as is,at as cs,au as Ne,av as os,aw as ds,Z as ps,L as us,I as hs,ax as ms,ay as fs,az as G,aA as ye,aB as xs,R as De,C as Ee,X as Le,Y as Ae,T as bs,J as js,aC as de}from"./CartesianChart-CgXDCfvu.js";import{A as gs,a as J}from"./AreaChart-XB2VmNLn.js";import{L as vs,B as Ns,a as ys}from"./BarChart-zbe0Gx8U.js";class ws{constructor(a){var{x:n,y:t}=a;this.xAxisScale=n,this.yAxisScale=t}map(a,n){var t,r,{position:c}=n;return{x:(t=this.xAxisScale.map(a.x,{position:c}))!==null&&t!==void 0?t:0,y:(r=this.yAxisScale.map(a.y,{position:c}))!==null&&r!==void 0?r:0}}mapWithFallback(a,n){var t,r,{position:c,fallback:o}=n,d,u;return o==="rangeMin"?d=this.yAxisScale.rangeMin():o==="rangeMax"?d=this.yAxisScale.rangeMax():d=0,o==="rangeMin"?u=this.xAxisScale.rangeMin():o==="rangeMax"?u=this.xAxisScale.rangeMax():u=0,{x:(t=this.xAxisScale.map(a.x,{position:c}))!==null&&t!==void 0?t:u,y:(r=this.yAxisScale.map(a.y,{position:c}))!==null&&r!==void 0?r:d}}isInRange(a){var{x:n,y:t}=a,r=n==null||this.xAxisScale.isInRange(n),c=t==null||this.yAxisScale.isInRange(t);return r&&c}}function we(s,a){var n=Object.keys(s);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(s);a&&(t=t.filter(function(r){return Object.getOwnPropertyDescriptor(s,r).enumerable})),n.push.apply(n,t)}return n}function Se(s){for(var a=1;a<arguments.length;a++){var n=arguments[a]!=null?arguments[a]:{};a%2?we(Object(n),!0).forEach(function(t){Ss(s,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(n)):we(Object(n)).forEach(function(t){Object.defineProperty(s,t,Object.getOwnPropertyDescriptor(n,t))})}return s}function Ss(s,a,n){return(a=Cs(a))in s?Object.defineProperty(s,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):s[a]=n,s}function Cs(s){var a=ks(s,"string");return typeof a=="symbol"?a:a+""}function ks(s,a){if(typeof s!="object"||!s)return s;var n=s[Symbol.toPrimitive];if(n!==void 0){var t=n.call(s,a);if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(s)}function re(){return re=Object.assign?Object.assign.bind():function(s){for(var a=1;a<arguments.length;a++){var n=arguments[a];for(var t in n)({}).hasOwnProperty.call(n,t)&&(s[t]=n[t])}return s},re.apply(null,arguments)}var Ms=(s,a)=>{var n;if(i.isValidElement(s))n=i.cloneElement(s,a);else if(typeof s=="function")n=s(a);else{if(!G(a.x1)||!G(a.y1)||!G(a.x2)||!G(a.y2))return null;n=i.createElement("line",re({},a,{className:"recharts-reference-line-line"}))}return n},Ds=(s,a,n,t,r,c)=>{var{x:o,width:d}=c,u=r.map(s,{position:n});if(!G(u)||a==="discard"&&!r.isInRange(u))return null;var p=[{x:o+d,y:u},{x:o,y:u}];return t==="left"?p.reverse():p},Es=(s,a,n,t,r,c)=>{var{y:o,height:d}=c,u=r.map(s,{position:n});if(!G(u)||a==="discard"&&!r.isInRange(u))return null;var p=[{x:u,y:o+d},{x:u,y:o}];return t==="top"?p.reverse():p},Ls=(s,a,n,t)=>{var r=[t.mapWithFallback(s[0],{position:n,fallback:"rangeMin"}),t.mapWithFallback(s[1],{position:n,fallback:"rangeMax"})];return a==="discard"&&r.some(c=>!t.isInRange(c))?null:r},As=(s,a,n,t,r,c,o)=>{var{x:d,y:u,segment:p,ifOverflow:m}=o,L=ye(d),f=ye(u);return f?Ds(u,m,t,c,a,n):L?Es(d,m,t,r,s,n):p!=null&&p.length===2?Ls(p,m,t,new ws({x:s,y:a})):null};function Os(s){var a=as();return i.useEffect(()=>(a(ts(s)),()=>{a(ns(s))})),null}function Is(s){var{xAxisId:a,yAxisId:n,shape:t,className:r,ifOverflow:c}=s,o=ls(),d=rs(),u=te(g=>is(g,a)),p=te(g=>cs(g,n)),m=te(g=>Ne(g,"xAxis",a,o)),L=te(g=>Ne(g,"yAxis",n,o)),f=os();if(!d||!f||u==null||p==null||m==null||L==null)return null;var j=As(m,L,f,s.position,u.orientation,p.orientation,s);if(!j)return null;var v=j[0],k=j[1];if(v==null||k==null)return null;var{x:M,y:N}=v,{x:$,y}=k,I=c==="hidden"?"url(#".concat(d,")"):void 0,A=Se(Se({clipPath:I},ds(s)),{},{x1:M,y1:N,x2:$,y2:y}),D=xs({x1:M,y1:N,x2:$,y2:y});return i.createElement(ps,{zIndex:s.zIndex},i.createElement(us,{className:hs("recharts-reference-line",r)},Ms(t,A),i.createElement(ms,re({},D,{lowerWidth:D.width,upperWidth:D.width}),i.createElement(fs,{label:s.label}),s.children)))}var Ps={ifOverflow:"discard",xAxisId:0,yAxisId:0,fill:"none",label:!1,stroke:"#ccc",fillOpacity:1,strokeWidth:1,position:"middle",zIndex:ss.line};function le(s){var a=es(s,Ps);return i.createElement(i.Fragment,null,i.createElement(Os,{yAxisId:a.yAxisId,xAxisId:a.xAxisId,ifOverflow:a.ifOverflow,x:a.x,y:a.y,segment:a.segment}),i.createElement(Is,a))}le.displayName="ReferenceLine";const $s={"one-off":{icon:"ðŸŽ",label:"One-off Deposit",className:"ps-scenario-card--inflow"},"recurring-deposit":{icon:"ðŸ“¥",label:"Recurring Deposit",className:"ps-scenario-card--inflow"},"recurring-withdrawal":{icon:"ðŸ“¤",label:"Recurring Withdrawal",className:"ps-scenario-card--outflow"}};function Rs({cashFlow:s,currencyCode:a,onEdit:n,onDelete:t,onToggle:r}){const c=$s[s.type],o=s.type!=="one-off",d=s.frequency==="annually"?"/ year":"/ month";return e.jsxs("div",{className:`ps-scenario-card ${c.className} ${s.enabled?"":"ps-scenario-card--disabled"}`,children:[e.jsxs("div",{className:"ps-scenario-card-actions",children:[e.jsx("button",{className:"ps-scenario-action-btn",onClick:()=>n(s.id),"aria-label":"Edit cash flow",children:"âœï¸"}),e.jsx("button",{className:"ps-scenario-action-btn",onClick:()=>t(s.id),"aria-label":"Delete cash flow",children:"ðŸ—‘ï¸"})]}),e.jsxs("div",{className:"ps-scenario-card-header",children:[e.jsxs("button",{className:`ps-scenario-toggle ${s.enabled?"ps-scenario-toggle--on":""}`,onClick:()=>r(s.id),"aria-label":s.enabled?"Disable cash flow":"Enable cash flow",children:[e.jsx("div",{className:"ps-scenario-toggle-track"}),e.jsx("div",{className:"ps-scenario-toggle-thumb"})]}),e.jsx("span",{className:"ps-scenario-icon",children:c.icon}),e.jsx("span",{className:"ps-scenario-type",children:s.label||c.label})]}),e.jsxs("div",{className:"ps-scenario-amount",children:[b(s.amount,a),o&&e.jsxs("span",{className:"ps-scenario-freq",children:[" ",d]})]}),o&&(s.startingValue??0)>0&&e.jsxs("div",{className:"ps-scenario-growth",children:[s.type==="recurring-withdrawal"?"Lump at start:":"Starting value:"," ",b(s.startingValue??0,a)]}),e.jsx("div",{className:"ps-scenario-dates",children:o?e.jsxs(e.Fragment,{children:[q(s.startDate)," â†’ ",s.endDate?q(s.endDate):"âˆž"]}):q(s.startDate)}),e.jsxs("div",{className:"ps-scenario-growth",children:["Growth: ",s.growthRate,"%"]})]})}const ie="#8b5cf6",z="#10b981",Z="#22d3ee";function Fs({active:s,payload:a,label:n,currencyCode:t}){var c;if(!s||!(a!=null&&a.length))return null;const r=(c=a[0])==null?void 0:c.payload;return r?e.jsxs("div",{className:"ps-tooltip",children:[e.jsx("p",{className:"ps-tooltip-title",children:n}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--p90",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:ie}}),"90th: ",b(r.p90,t)]}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--p75",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:z}}),"75th: ",b(r.p75,t)]}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--median",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:Z}}),"Median: ",b(r.median,t)]}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--p25",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:z}}),"25th: ",b(r.p25,t)]}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--p10",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:ie}}),"10th: ",b(r.p10,t)]})]}):null}function _s(s,a=30){if(!s.length)return[];const n=s[0],t=s[s.length-1];if(n===t)return[{binStart:n,binEnd:t,count:s.length,label:""}];const r=(t-n)/a,c=[];for(let o=0;o<a;o++){const d=n+o*r,u=d+r;c.push({binStart:d,binEnd:u,count:0,label:""})}for(const o of s){let d=Math.floor((o-n)/r);d>=a&&(d=a-1),d<0&&(d=0),c[d].count++}for(const o of c){const d=(o.binStart+o.binEnd)/2;d>=1e6?o.label=`${(d/1e6).toFixed(1)}M`:d>=1e3?o.label=`${(d/1e3).toFixed(0)}K`:o.label=String(Math.round(d))}return c}function pe(s,a){if(!s.length)return 0;const n=a/100*(s.length-1),t=Math.floor(n),r=Math.ceil(n);return t===r?s[t]:s[t]+(s[r]-s[t])*(n-t)}function zs({distribution:s,currencyCode:a,hoveredLabel:n}){var d,u,p;const t=i.useMemo(()=>_s(s,30),[s]),r=i.useMemo(()=>pe(s,25),[s]),c=i.useMemo(()=>pe(s,50),[s]),o=i.useMemo(()=>pe(s,75),[s]);return t.length?e.jsxs("div",{className:"ps-dist-view",children:[e.jsxs("div",{className:"ps-dist-header",children:[e.jsxs("h3",{className:"ps-dist-title",children:["Outcome Distribution â€” ",n||"End of Horizon"]}),e.jsx("p",{className:"ps-dist-subtitle",children:"Each bar shows how many simulations landed in that value range. Highlighted regions mark the key percentiles."})]}),e.jsxs("div",{className:"ps-dist-stats",children:[e.jsxs("div",{className:"ps-dist-stat",children:[e.jsx("span",{className:"ps-dist-stat-label",style:{color:"#eab308"},children:"25th (Pessimistic)"}),e.jsx("span",{className:"ps-dist-stat-value",children:b(Math.round(r),a)})]}),e.jsxs("div",{className:"ps-dist-stat",children:[e.jsx("span",{className:"ps-dist-stat-label",style:{color:Z},children:"Median (Expected)"}),e.jsx("span",{className:"ps-dist-stat-value",children:b(Math.round(c),a)})]}),e.jsxs("div",{className:"ps-dist-stat",children:[e.jsx("span",{className:"ps-dist-stat-label",style:{color:z},children:"75th (Optimistic)"}),e.jsx("span",{className:"ps-dist-stat-value",children:b(Math.round(o),a)})]})]}),e.jsx("div",{className:"ps-chart-container",children:e.jsx(De,{width:"100%",height:300,children:e.jsxs(Ns,{data:t,margin:{top:20,right:10,left:10,bottom:5},children:[e.jsx(Ee,{strokeDasharray:"3 3",stroke:"var(--border-color)",vertical:!1}),e.jsx(Le,{dataKey:"label",tick:{fill:"var(--text-muted)",fontSize:10},axisLine:{stroke:"var(--border-color)"},tickLine:!1,interval:Math.max(0,Math.floor(t.length/6)-1)}),e.jsx(Ae,{tick:{fill:"var(--text-muted)",fontSize:11},axisLine:!1,tickLine:!1}),e.jsx(ys,{dataKey:"count",radius:[2,2,0,0],animationDuration:400,children:t.map((m,L)=>{const f=(m.binStart+m.binEnd)/2;let j="rgba(139, 92, 246, 0.5)";return f>=r&&f<=o&&(j="rgba(16, 185, 129, 0.6)"),e.jsx(js,{fill:j},L)})}),e.jsx(le,{x:(d=t.find(m=>(m.binStart+m.binEnd)/2>=c))==null?void 0:d.label,stroke:Z,strokeWidth:2,strokeDasharray:"4 4",children:e.jsx(de,{value:"Median",position:"top",fill:Z,fontSize:11})}),e.jsx(le,{x:(u=t.find(m=>(m.binStart+m.binEnd)/2>=r))==null?void 0:u.label,stroke:"#eab308",strokeWidth:1.5,strokeDasharray:"4 4",children:e.jsx(de,{value:"25th",position:"top",fill:"#eab308",fontSize:10})}),e.jsx(le,{x:(p=t.find(m=>(m.binStart+m.binEnd)/2>=o))==null?void 0:p.label,stroke:z,strokeWidth:1.5,strokeDasharray:"4 4",children:e.jsx(de,{value:"75th",position:"top",fill:z,fontSize:10})})]})})})]}):null}function Ts({data:s,result:a,currencyCode:n}){const[t,r]=i.useState(!1),[c,o]=i.useState(""),d=i.useMemo(()=>s.map(p=>({...p,p10_base:p.p10,band_10_25:Math.max(0,p.p25-p.p10),band_25_75:Math.max(0,p.p75-p.p25),band_75_90:Math.max(0,p.p90-p.p75)})),[s]),u=i.useCallback(p=>{p!=null&&p.activeLabel&&o(p.activeLabel)},[]);return s.length?e.jsxs("div",{className:`ps-flip-container ${t?"ps-flip-container--flipped":""}`,children:[e.jsxs("div",{className:"ps-flip-face ps-flip-face--front",children:[e.jsxs("div",{className:"ps-flip-header",children:[e.jsx("h2",{className:"ps-card-title",children:"Monte Carlo Simulation"}),e.jsx("button",{className:"ps-flip-btn",onClick:()=>r(!0),title:"Show outcome distribution",children:"ðŸ“Š Distribution"})]}),e.jsx("div",{className:"ps-chart-container",children:e.jsx(De,{width:"100%",height:380,children:e.jsxs(gs,{data:d,margin:{top:10,right:10,left:10,bottom:0},onMouseMove:u,children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"outerBandGrad",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:ie,stopOpacity:.4}),e.jsx("stop",{offset:"100%",stopColor:ie,stopOpacity:.08})]}),e.jsxs("linearGradient",{id:"innerBandGrad",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:z,stopOpacity:.5}),e.jsx("stop",{offset:"100%",stopColor:z,stopOpacity:.12})]})]}),e.jsx(Ee,{strokeDasharray:"3 3",stroke:"var(--border-color)",vertical:!1}),e.jsx(Le,{dataKey:"label",tick:{fill:"var(--text-muted)",fontSize:11},axisLine:{stroke:"var(--border-color)"},tickLine:!1,interval:"preserveStartEnd"}),e.jsx(Ae,{tick:{fill:"var(--text-muted)",fontSize:11},axisLine:!1,tickLine:!1,tickFormatter:p=>p>=1e6?`${(p/1e6).toFixed(1)}M`:p>=1e3?`${(p/1e3).toFixed(0)}K`:String(p)}),e.jsx(bs,{content:e.jsx(Fs,{currencyCode:n}),cursor:{stroke:"rgba(255,255,255,0.1)"}}),e.jsx(J,{dataKey:"p10_base",stackId:"bands",stroke:"none",fill:"transparent",legendType:"none",animationDuration:600}),e.jsx(J,{dataKey:"band_10_25",stackId:"bands",stroke:"none",fill:"url(#outerBandGrad)",name:"10thâ€“90th",animationDuration:600}),e.jsx(J,{dataKey:"band_25_75",stackId:"bands",stroke:"none",fill:"url(#innerBandGrad)",name:"25thâ€“75th",animationDuration:600}),e.jsx(J,{dataKey:"band_75_90",stackId:"bands",stroke:"none",fill:"url(#outerBandGrad)",legendType:"none",animationDuration:600}),e.jsx(J,{dataKey:"median",stroke:Z,strokeWidth:2.5,fill:"none",name:"Median",dot:!1,animationDuration:800}),e.jsx(vs,{wrapperStyle:{fontSize:12,color:"var(--text-secondary)"}})]})})})]}),e.jsxs("div",{className:"ps-flip-face ps-flip-face--back",children:[e.jsx("div",{className:"ps-flip-header",children:e.jsx("button",{className:"ps-flip-btn",onClick:()=>r(!1),title:"Show Monte Carlo chart",children:"ðŸ“ˆ Monte Carlo"})}),e.jsx(zs,{distribution:a.finalDistribution,currencyCode:n,hoveredLabel:c})]})]}):null}function ne(s){const[a,n]=s.split("-").map(Number);return a+(n-1)/12}function Vs(s,a){const n=a-s;let t=1;n>25?t=5:n>12?t=3:n>6&&(t=2);const r=[],c=Math.ceil(s/t)*t;for(let o=c;o<=a;o+=t)r.push(o);return r}const Oe={"one-off":{sign:"+",colorClass:"ps-tl-bar--inflow"},"recurring-deposit":{sign:"+",colorClass:"ps-tl-bar--inflow"},"recurring-withdrawal":{sign:"âˆ’",colorClass:"ps-tl-bar--outflow"}};function Ie(s,a){const n=Oe[s.type],t=s.type==="one-off"?"":s.frequency==="annually"?"/yr":"/mo";return`${n.sign}${b(s.amount,a)}${t}`}function Bs(s,a){const n=[s.label];if(n.push(Ie(s,a)),s.type!=="one-off"&&(s.startingValue??0)>0){const t=b(s.startingValue,a);n.push(s.type==="recurring-withdrawal"?`Lump: ${t}`:`Starting: ${t}`)}return s.type==="one-off"?n.push(q(s.startDate)):n.push(`${q(s.startDate)} â†’ ${s.endDate?q(s.endDate):"âˆž"}`),n.push(`Growth: ${s.growthRate}%`),n.join(`
`)}function Ws({cashFlows:s,simulationEnd:a,currencyCode:n,onEdit:t}){const[r,c]=i.useState(!1);if(s.length===0)return null;const o=P(),d=ne(o),u=ne(a),p=Math.max(1,u-d),m=Vs(Math.floor(d),Math.ceil(u)),L=[...s].sort((f,j)=>{const v={"one-off":0,"recurring-deposit":1,"recurring-withdrawal":2};return v[f.type]-v[j.type]});return e.jsxs("div",{className:"ps-card ps-tl-card",children:[e.jsx("div",{className:"ps-tl-header",children:e.jsxs("button",{className:"ps-table-toggle",onClick:()=>c(f=>!f),"aria-expanded":r,children:[e.jsx("span",{children:"Timeline"}),e.jsx("span",{className:`ps-table-arrow ${r?"ps-table-arrow--open":""}`,children:"â–¼"})]})}),e.jsx("div",{className:`ps-tl-body ${r?"ps-tl-body--open":""}`,children:e.jsxs("div",{className:"ps-tl-content",children:[e.jsx("div",{className:"ps-tl-rows",children:L.map(f=>{const j=Oe[f.type],v=ne(f.startDate),k=f.endDate?ne(f.endDate):v,M=Math.max(0,(v-d)/p*100),N=(k-v)/p*100,$=Math.max(5,N),y=Math.min($,100-M),I=y<18,A=Ie(f,n);return e.jsx("div",{className:"ps-tl-row",title:Bs(f,n),children:e.jsx("div",{className:`ps-tl-bar ${j.colorClass} ${f.enabled?"":"ps-tl-bar--disabled"} ${t?"ps-tl-bar--clickable":""}`,style:{left:`${M}%`,width:`${y}%`},onClick:t?()=>t(f.id):void 0,role:t?"button":void 0,tabIndex:t?0:void 0,onKeyDown:t?D=>{(D.key==="Enter"||D.key===" ")&&t(f.id)}:void 0,children:I?e.jsx("span",{className:"ps-tl-bar-amount",children:A}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"ps-tl-bar-label",children:f.label}),e.jsx("span",{className:"ps-tl-bar-amount",children:A})]})})},f.id)})}),e.jsx("div",{className:"ps-tl-axis",children:m.map(f=>{const j=(f-d)/p*100;return e.jsx("span",{className:"ps-tl-axis-label",style:{left:`${j}%`},children:f},f)})})]})})]})}function _(s,a){const[n,t]=s.split("-").map(Number),r=n*12+(t-1)+a,c=Math.floor(r/12),o=r%12+1;return`${c}-${String(o).padStart(2,"0")}`}function Ce(){try{const s=localStorage.getItem("vibe-finance-sim-default-years"),a=Number(s);if(!Number.isNaN(a))return Math.min(60,Math.max(5,Math.round(a)))}catch{}return 30}function ke({value:s,onChange:a,symbol:n,ariaLabel:t}){const[r,c]=i.useState(s.toLocaleString("en-GB"));i.useEffect(()=>{c(s.toLocaleString("en-GB"))},[s]);const o=()=>{const d=Number(r.replace(/,/g,""));isNaN(d)?c(s.toLocaleString("en-GB")):a(d)};return e.jsxs("div",{className:"ps-currency-input",children:[e.jsx("span",{className:"ps-currency-prefix",children:n}),e.jsx("input",{type:"text",inputMode:"numeric",value:r,onChange:d=>c(d.target.value),onBlur:o,"aria-label":t})]})}function Pe({value:s,onChange:a,suffix:n,ariaLabel:t,min:r=0,max:c}){const[o,d]=i.useState(String(s));i.useEffect(()=>{d(String(s))},[s]);const u=()=>{let p=Number(o);if(isNaN(p)){d(String(s));return}r!==void 0&&(p=Math.max(r,p)),c!==void 0&&(p=Math.min(c,p)),a(p)};return e.jsxs("div",{className:"ps-numeric-input",children:[e.jsx("input",{type:"text",inputMode:"decimal",value:o,onChange:p=>d(p.target.value),onBlur:u,"aria-label":t}),n&&e.jsx("span",{className:"ps-numeric-suffix",children:n})]})}function ue({value:s,onChange:a,ariaLabel:n}){return e.jsx("input",{type:"month",className:"ps-month-input",value:s,onChange:t=>a(t.target.value),"aria-label":n})}function Gs({initial:s,currencySymbol:a,savedLabels:n,onSave:t,onCancel:r,onDirtyChange:c,onRegisterSubmit:o,onLabelSaved:d,onLabelDeleted:u}){const p=!!s,[m,L]=i.useState((s==null?void 0:s.type)??"recurring-deposit"),[f,j]=i.useState((s==null?void 0:s.label)??""),[v,k]=i.useState(!1),M=i.useRef(null),[N,$]=i.useState((s==null?void 0:s.amount)??0),[y,I]=i.useState((s==null?void 0:s.startingValue)??0),[A,D]=i.useState((s==null?void 0:s.growthRate)??5),[g,T]=i.useState((s==null?void 0:s.startDate)??P()),[F,V]=i.useState((s==null?void 0:s.endDate)??_(P(),180)),[R,K]=i.useState((s==null?void 0:s.frequency)??"monthly");i.useEffect(()=>{p||(j(""),$(0),I(0),D(5),T(P()),V(_(P(),180)),K("monthly"))},[m,p]);const w=m!=="one-off",E=i.useMemo(()=>s?{type:s.type,label:s.label??"",amount:s.amount,startingValue:s.startingValue??0,growthRate:s.growthRate,startDate:s.startDate,endDate:s.endDate??_(P(),180),frequency:s.frequency??"monthly"}:{type:m,label:"",amount:0,startingValue:0,growthRate:5,startDate:P(),endDate:_(P(),180),frequency:"monthly"},[s,m]),Q=i.useMemo(()=>{const S=m!==E.type||f!==E.label||N!==E.amount||A!==E.growthRate||g!==E.startDate;return w?S||y!==E.startingValue||F!==E.endDate||R!==E.frequency:S},[m,f,N,A,g,w,y,F,R,E]);i.useEffect(()=>{c==null||c(Q)},[Q,c]),i.useEffect(()=>()=>{c==null||c(!1)},[c]);const Y=()=>{const S=f||(m==="one-off"?"One-off":m==="recurring-deposit"?"Deposit":"Withdrawal");f.trim()&&(d==null||d(f.trim())),t({id:(s==null?void 0:s.id)??Me(),type:m,label:S,amount:N,startingValue:w?y:void 0,growthRate:A,startDate:g,endDate:w?F:void 0,frequency:w?R:void 0,enabled:(s==null?void 0:s.enabled)??!0})};return i.useEffect(()=>(o==null||o(Y),()=>o==null?void 0:o(null)),[o,Y]),e.jsxs("div",{className:"ps-scenario-form",children:[e.jsx("h3",{className:"ps-form-title",children:p?"Edit Cash Flow":"New Cash Flow"}),!p&&e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"Type"}),e.jsxs("div",{className:"ps-type-selector",children:[e.jsx("button",{className:`ps-type-btn ps-type-btn--inflow ${m==="recurring-deposit"?"ps-type-btn--active":""}`,onClick:()=>L("recurring-deposit"),children:"ðŸ“¥ Deposit"}),e.jsx("button",{className:`ps-type-btn ps-type-btn--outflow ${m==="recurring-withdrawal"?"ps-type-btn--active":""}`,onClick:()=>L("recurring-withdrawal"),children:"ðŸ“¤ Withdrawal"}),e.jsx("button",{className:`ps-type-btn ps-type-btn--inflow ${m==="one-off"?"ps-type-btn--active":""}`,onClick:()=>L("one-off"),children:"ðŸŽ One-off"})]})]}),e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"Label"}),e.jsxs("div",{className:"ps-label-combo",children:[e.jsx("input",{ref:M,type:"text",className:"ps-text-input",value:f,onChange:S=>{j(S.target.value),k(!0)},onFocus:()=>k(!0),onBlur:()=>{setTimeout(()=>k(!1),150)},placeholder:"e.g. Inheritance, Pension, Salary...","aria-label":"Cash flow label"}),v&&n.length>0&&e.jsx("div",{className:"ps-label-dropdown",children:n.filter(S=>!f||S.toLowerCase().includes(f.toLowerCase())).map(S=>e.jsxs("div",{className:"ps-label-dropdown-item",children:[e.jsx("button",{className:"ps-label-dropdown-pick",onMouseDown:H=>{H.preventDefault(),j(S),k(!1)},children:S}),e.jsx("button",{className:"ps-label-dropdown-del",onMouseDown:H=>{H.preventDefault(),u==null||u(S)},"aria-label":`Remove ${S}`,children:"Ã—"})]},S))})]})]}),w&&e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:m==="recurring-withdrawal"?"Lump Withdrawal":"Starting Value"}),e.jsx(ke,{value:y,onChange:I,symbol:a,ariaLabel:m==="recurring-withdrawal"?"Lump withdrawal amount":"Starting value amount"})]}),e.jsxs("div",{className:"ps-field",children:[e.jsxs("label",{className:"ps-label",children:["Amount",w?` (${R==="monthly"?"per month":"per year"})`:""]}),e.jsx(ke,{value:N,onChange:$,symbol:a,ariaLabel:"Cash flow amount"})]}),w&&e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"Frequency"}),e.jsxs("div",{className:"ps-toggle",children:[e.jsx("button",{className:`ps-toggle-btn ${R==="monthly"?"ps-toggle-btn--active":""}`,onClick:()=>K("monthly"),children:"Monthly"}),e.jsx("button",{className:`ps-toggle-btn ${R==="annually"?"ps-toggle-btn--active":""}`,onClick:()=>K("annually"),children:"Annually"})]})]}),e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:w?"Start Date":"Date"}),e.jsx(ue,{value:g,onChange:T,ariaLabel:"Start date"})]}),w&&e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"End Date"}),e.jsx(ue,{value:F,onChange:V,ariaLabel:"End date"})]}),e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"Annual Growth Rate"}),e.jsx(Pe,{value:A,onChange:D,suffix:"%",ariaLabel:"Annual growth rate",min:0,max:50})]}),e.jsxs("div",{className:"ps-form-actions",children:[e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:r,children:"Cancel"}),e.jsx("button",{className:"ps-btn ps-btn--primary",onClick:Y,children:p?"Save Changes":"Add Cash Flow"})]})]})}function Xs(){const{currency:s}=Ye(),{user:a}=He(),[n,t]=W("vf-ps-sim-end",()=>_(P(),Ce()*12)),[r,c]=W("vf-ps-cash-flows",[]),[o,d]=W("vf-ps-scenarios",[]),[u,p]=W("vf-ps-active-id",null),[m,L]=i.useState("all"),[f]=i.useState(12),j=500,[v,k]=i.useState(!1),[M,N]=i.useState(null),[$,y]=i.useState(!1),I=i.useRef(null),A=i.useRef(null),[D,g]=i.useState(null),[T,F]=W("vf-ps-horizon-mode","years"),[V,R]=i.useState(!1),[K,w]=i.useState(!1),{gate:E,showLogin:Q,onLoginSuccess:Y,onLoginClose:S}=Ue(),[H,he]=i.useState(!1),[U,me]=i.useState(""),[$e,ee]=i.useState(!1),[X,fe]=i.useState(""),[Re,xe]=W("vf-ps-labels",[]),C=o.find(l=>l.id===u)??null,ce=i.useMemo(()=>C?C.simulationEnd!==n||JSON.stringify(C.cashFlows)!==JSON.stringify(r):r.length>0,[C,n,r]);i.useEffect(()=>{if(!a)return;let l=!1;return he(!0),Xe(a.uid).then(h=>{l||h.length>0&&d(h)}).catch(h=>console.error("[scenarios] fetch failed:",h)).finally(()=>{l||he(!1)}),()=>{l=!0}},[a,d]);const O=i.useMemo(()=>r.length===0?null:Qe({startingBalance:0,cashFlows:r,volatility:f,numPaths:j,endOverride:n}),[r,f,j,n]),be=i.useCallback(l=>{E(()=>{const h={id:Me(),name:l,startingBalance:0,simulationEnd:n,cashFlows:[...r]};d(x=>[...x,h]),p(h.id),a&&oe(a.uid,h).catch(x=>console.error("[scenarios] save-as failed:",x))})},[a,E,n,r,d,p]),Fe=i.useCallback(()=>{u&&E(()=>{const l={id:u,name:(C==null?void 0:C.name)??"Scenario",startingBalance:0,simulationEnd:n,cashFlows:[...r]};d(h=>h.map(x=>x.id===u?l:x)),a&&oe(a.uid,l).catch(h=>console.error("[scenarios] save failed:",h))})},[a,E,u,C,n,r,d]),_e=i.useCallback(l=>{const h=o.find(x=>x.id===l);h&&(p(l),t(h.simulationEnd),c(h.cashFlows))},[o,p,t,c]),se=i.useCallback(()=>{p(null),t(_(P(),Ce()*12)),c([]),k(!1),N(null)},[p,t,c]),ze=i.useCallback(l=>{d(h=>h.filter(x=>x.id!==l)),a&&Je(a.uid,l).catch(h=>console.error("[scenarios] delete failed:",h)),u===l&&se()},[a,u,d,se]),je=i.useCallback(l=>{if(!(!u||!l.trim())){if(d(h=>h.map(x=>x.id===u?{...x,name:l.trim()}:x)),a){const h=o.find(x=>x.id===u);h&&oe(a.uid,{...h,name:l.trim()}).catch(x=>console.error("[scenarios] rename failed:",x))}ee(!1)}},[a,u,o,d]),ae=i.useCallback(l=>{const h=r.find(x=>x.id===l);h&&(y(!1),N(h),k(!0))},[r]),Te=i.useCallback(()=>{y(!1),N(null),k(!0)},[]),ge=i.useCallback(l=>{if(!(v&&(M==null?void 0:M.id)===l)){if(v&&$){g(l);return}ae(l)}},[v,M,$,ae]),Ve=i.useCallback(()=>{var l;A.current=D,g(null),(l=I.current)==null||l.call(I)},[D]),Be=i.useCallback(()=>{const l=D;g(null),l&&ae(l)},[D,ae]),ve=i.useCallback(()=>{g(null)},[]),We=i.useCallback(l=>{c(h=>h.filter(x=>x.id!==l))},[c]),Ge=i.useCallback(l=>{c(h=>h.map(x=>x.id===l?{...x,enabled:!x.enabled}:x))},[c]),qe=i.useCallback(l=>{c(M?x=>x.map(B=>B.id===l.id?l:B):x=>[...x,l]),y(!1);const h=A.current;if(h){A.current=null;const x=r.find(B=>B.id===h);if(x){N(x);return}}k(!1),N(null)},[M,c,r]),Ke=i.useCallback(()=>{y(!1),k(!1),N(null)},[]);return e.jsxs("div",{className:"ps-page",children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{className:"page-title",children:"Portfolio Simulator"}),e.jsx("p",{className:"page-subtitle",children:"Simulate your financial future with Monte Carlo analysis."})]}),e.jsxs("div",{className:"ps-grid",children:[e.jsxs("div",{className:"ps-left",children:[e.jsxs("div",{className:"ps-card ps-scn-card",children:[e.jsxs("div",{className:"ps-scn-header",children:[e.jsx("h2",{className:"ps-card-title",children:"ðŸ“‹ Scenario"}),C&&!ce&&e.jsx("span",{className:"ps-scn-badge ps-scn-badge--saved",children:"Saved"}),ce&&e.jsx("span",{className:"ps-scn-badge ps-scn-badge--dirty",children:"Unsaved"})]}),o.length>0&&e.jsxs("select",{className:"ps-scn-select",value:u??"",onChange:l=>l.target.value?_e(l.target.value):se(),children:[e.jsx("option",{value:"",children:"â€” New scenario â€”"}),o.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]}),K?e.jsxs("div",{className:"ps-scn-save-row",children:[e.jsx("input",{className:"ps-text-input",placeholder:"Scenario nameâ€¦",value:U,onChange:l=>me(l.target.value),onKeyDown:l=>{l.key==="Enter"&&U.trim()&&(be(U.trim()),w(!1)),l.key==="Escape"&&w(!1)},autoFocus:!0}),e.jsx("button",{className:"ps-btn ps-btn--primary",disabled:!U.trim(),onClick:()=>{be(U.trim()),w(!1)},children:"Save"}),e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:()=>w(!1),children:"Cancel"})]}):$e?e.jsxs("div",{className:"ps-scn-save-row",children:[e.jsx("input",{className:"ps-text-input",placeholder:"New nameâ€¦",value:X,onChange:l=>fe(l.target.value),onKeyDown:l=>{l.key==="Enter"&&X.trim()&&je(X),l.key==="Escape"&&ee(!1)},autoFocus:!0}),e.jsx("button",{className:"ps-btn ps-btn--primary",disabled:!X.trim(),onClick:()=>je(X),children:"Rename"}),e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:()=>ee(!1),children:"Cancel"})]}):e.jsxs("div",{className:"ps-scn-actions",children:[u&&ce&&e.jsx("button",{className:"ps-btn ps-btn--primary",onClick:Fe,children:"ðŸ’¾ Save"}),e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:()=>{w(!0),me(C!=null&&C.name?`${C.name} copy`:"")},children:"Save asâ€¦"}),e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:se,children:"+ New"}),u&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:()=>{ee(!0),fe((C==null?void 0:C.name)??"")},children:"âœï¸"}),e.jsx("button",{className:"ps-btn ps-btn--secondary ps-btn--danger",onClick:()=>ze(u),children:"ðŸ—‘ï¸"})]})]}),!a&&e.jsx("button",{className:"ps-login-prompt",onClick:()=>E(()=>{}),children:"ðŸ”’ Sign in to save scenarios to your account"}),H&&e.jsx("div",{className:"ps-sync-indicator",children:"Syncingâ€¦"})]}),e.jsxs("div",{className:"ps-card",children:[e.jsx("h2",{className:"ps-card-title",children:"Simulation Setup"}),e.jsxs("div",{className:"ps-field",children:[e.jsxs("div",{className:"ps-label-row",children:[e.jsx("label",{className:"ps-label",children:"Horizon"}),e.jsxs("div",{className:"ps-toggle ps-toggle--sm",children:[e.jsx("button",{className:`ps-toggle-btn ${T==="years"?"ps-toggle-btn--active":""}`,onClick:()=>F("years"),children:"Years"}),e.jsx("button",{className:`ps-toggle-btn ${T==="date"?"ps-toggle-btn--active":""}`,onClick:()=>F("date"),children:"Date"})]})]}),T==="years"?e.jsx(Pe,{value:(()=>{const[l,h]=n.split("-").map(Number),x=new Date,B=l*12+h-(x.getFullYear()*12+(x.getMonth()+1));return Math.max(1,Math.round(B/12))})(),onChange:l=>t(_(P(),Math.round(l*12))),suffix:"years",ariaLabel:"Simulation horizon in years",min:1,max:100}):e.jsx(ue,{value:n,onChange:t,ariaLabel:"Simulation end date"})]}),e.jsx("button",{className:"ps-btn ps-btn--gold ps-btn--full",onClick:Te,children:"+ Add Cash Flow"})]}),v&&e.jsx("div",{className:"ps-card ps-card--form",children:e.jsx(Gs,{initial:M??void 0,currencySymbol:s.symbol,savedLabels:Re,onSave:qe,onCancel:Ke,onDirtyChange:y,onRegisterSubmit:l=>{I.current=l},onLabelSaved:l=>xe(h=>h.includes(l)?h:[...h,l].sort()),onLabelDeleted:l=>xe(h=>h.filter(x=>x!==l))})}),r.length>0&&e.jsxs("div",{className:"ps-card",children:[e.jsxs("h2",{className:"ps-card-title",children:["Cash Flows",e.jsx("span",{className:"ps-scenario-count",children:r.length})]}),e.jsx("div",{className:"ps-filter",children:["all","deposits","withdrawals"].map(l=>e.jsx("button",{className:`ps-filter-btn ${m===l?"ps-filter-btn--active":""}`,onClick:()=>L(l),children:l==="all"?"All":l==="deposits"?"ðŸ“¥ Deposits":"ðŸ“¤ Withdrawals"},l))}),e.jsx("div",{className:"ps-scenario-list",children:r.filter(l=>m==="all"?!0:m==="deposits"?l.type!=="recurring-withdrawal":l.type==="recurring-withdrawal").map(l=>e.jsx(Rs,{cashFlow:l,currencyCode:s.code,onEdit:ge,onDelete:We,onToggle:Ge},l.id))})]})]}),e.jsxs("div",{className:"ps-right",children:[O&&e.jsxs("div",{className:"ps-card ps-results-card",children:[e.jsx("h2",{className:"ps-card-title",children:"Results"}),e.jsxs("div",{className:"ps-results-grid",children:[e.jsxs("div",{className:"ps-result-item",children:[e.jsx("span",{className:"ps-result-label",children:"Median (Expected)"}),e.jsx("span",{className:"ps-result-value ps-result-value--cyan",children:b(O.finalMedian,s.code)})]}),e.jsxs("div",{className:"ps-result-item",children:[e.jsx("span",{className:"ps-result-label",children:"Optimistic (75th)"}),e.jsx("span",{className:"ps-result-value ps-result-value--green",children:b(O.finalP75,s.code)})]}),e.jsxs("div",{className:"ps-result-item",children:[e.jsx("span",{className:"ps-result-label",children:"Pessimistic (25th)"}),e.jsx("span",{className:"ps-result-value ps-result-value--yellow",children:b(O.finalP25,s.code)})]})]})]}),O&&O.timeSteps.length>0&&e.jsx("div",{className:"ps-card ps-chart-card",children:e.jsx(Ts,{data:O.timeSteps,result:O,currencyCode:s.code})}),r.length>0&&e.jsx(Ws,{cashFlows:r,simulationEnd:n,currencyCode:s.code,onEdit:ge}),O&&O.timeSteps.length>0&&e.jsxs("div",{className:"ps-card ps-table-card",children:[e.jsx("div",{className:"ps-table-header",children:e.jsxs("button",{className:"ps-table-toggle",onClick:()=>R(l=>!l),"aria-expanded":V,children:[e.jsx("span",{children:"Table"}),e.jsx("span",{className:`ps-table-arrow ${V?"ps-table-arrow--open":""}`,children:"â–¼"})]})}),e.jsx("div",{className:`ps-table-body ${V?"ps-table-body--open":""}`,children:e.jsx("div",{className:"ps-table-scroll",children:e.jsxs("table",{className:"ps-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"ps-th ps-th--left",children:"Year"}),e.jsx("th",{className:"ps-th ps-th--right",children:"10th"}),e.jsx("th",{className:"ps-th ps-th--right",children:"25th"}),e.jsx("th",{className:"ps-th ps-th--right",children:"Median"}),e.jsx("th",{className:"ps-th ps-th--right",children:"75th"}),e.jsx("th",{className:"ps-th ps-th--right",children:"90th"})]})}),e.jsx("tbody",{children:O.timeSteps.map((l,h)=>e.jsxs("tr",{className:"ps-tr",children:[e.jsx("td",{className:"ps-td ps-td--left",children:l.label}),e.jsx("td",{className:"ps-td ps-td--right",children:b(l.p10,s.code)}),e.jsx("td",{className:"ps-td ps-td--right",children:b(l.p25,s.code)}),e.jsx("td",{className:"ps-td ps-td--right ps-td--accent",children:b(l.median,s.code)}),e.jsx("td",{className:"ps-td ps-td--right",children:b(l.p75,s.code)}),e.jsx("td",{className:"ps-td ps-td--right",children:b(l.p90,s.code)})]},h))})]})})})]}),!O&&e.jsxs("div",{className:"ps-card ps-empty-card",children:[e.jsx("div",{className:"ps-empty-icon",children:"ðŸ“Š"}),e.jsx("h2",{className:"ps-empty-title",children:"No Simulation Yet"}),e.jsx("p",{className:"ps-empty-text",children:"Add some cash flows to see your Monte Carlo simulation."})]})]})]}),D&&e.jsx("div",{className:"confirm-overlay",onClick:ve,children:e.jsxs("div",{className:"confirm-dialog",onClick:l=>l.stopPropagation(),children:[e.jsx("p",{className:"confirm-message",children:"You have unsaved changes"}),e.jsxs("div",{className:"confirm-actions",children:[e.jsx("button",{className:"confirm-btn confirm-btn--cancel",onClick:ve,children:"Cancel"}),e.jsx("button",{className:"confirm-btn confirm-btn--discard",onClick:Be,children:"Discard"}),e.jsx("button",{className:"confirm-btn confirm-btn--save",onClick:Ve,children:"Save"})]})]})}),Q&&e.jsx(Ze,{onClose:S,onSuccess:Y})]})}export{Xs as PortfolioSimulatorPage};

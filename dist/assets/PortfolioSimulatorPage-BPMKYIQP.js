import{r as i,j as e,f as b,u as Ue,b as Xe,c as G,a as Je,d as Ze,e as ue,g as Qe,L as es}from"./index-DEeJu2ck.js";import{f as K,c as I,r as ss,g as Ee}from"./simulationEngine-DmQAKyWZ.js";import{A as as,D as ts,af as ns,ao as ls,ap as rs,aq as is,ar as cs,G as le,as as os,at as ds,au as we,av as ps,aw as us,Z as hs,L as ms,I as fs,ax as xs,ay as bs,az as q,aA as Se,aB as gs,R as Le,C as Ae,X as Oe,Y as Pe,T as js,J as vs,aC as he}from"./CartesianChart-DPm9Ip4b.js";import{A as Ns,a as Z}from"./AreaChart-GndWs6tQ.js";import{L as ys,B as ws,a as Ss}from"./BarChart-ByEMwz5E.js";class ks{constructor(a){var{x:t,y:n}=a;this.xAxisScale=t,this.yAxisScale=n}map(a,t){var n,r,{position:c}=t;return{x:(n=this.xAxisScale.map(a.x,{position:c}))!==null&&n!==void 0?n:0,y:(r=this.yAxisScale.map(a.y,{position:c}))!==null&&r!==void 0?r:0}}mapWithFallback(a,t){var n,r,{position:c,fallback:o}=t,d,u;return o==="rangeMin"?d=this.yAxisScale.rangeMin():o==="rangeMax"?d=this.yAxisScale.rangeMax():d=0,o==="rangeMin"?u=this.xAxisScale.rangeMin():o==="rangeMax"?u=this.xAxisScale.rangeMax():u=0,{x:(n=this.xAxisScale.map(a.x,{position:c}))!==null&&n!==void 0?n:u,y:(r=this.yAxisScale.map(a.y,{position:c}))!==null&&r!==void 0?r:d}}isInRange(a){var{x:t,y:n}=a,r=t==null||this.xAxisScale.isInRange(t),c=n==null||this.yAxisScale.isInRange(n);return r&&c}}function ke(s,a){var t=Object.keys(s);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(s);a&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(s,r).enumerable})),t.push.apply(t,n)}return t}function Ce(s){for(var a=1;a<arguments.length;a++){var t=arguments[a]!=null?arguments[a]:{};a%2?ke(Object(t),!0).forEach(function(n){Cs(s,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(t)):ke(Object(t)).forEach(function(n){Object.defineProperty(s,n,Object.getOwnPropertyDescriptor(t,n))})}return s}function Cs(s,a,t){return(a=Ms(a))in s?Object.defineProperty(s,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[a]=t,s}function Ms(s){var a=Ds(s,"string");return typeof a=="symbol"?a:a+""}function Ds(s,a){if(typeof s!="object"||!s)return s;var t=s[Symbol.toPrimitive];if(t!==void 0){var n=t.call(s,a);if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(s)}function ce(){return ce=Object.assign?Object.assign.bind():function(s){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var n in t)({}).hasOwnProperty.call(t,n)&&(s[n]=t[n])}return s},ce.apply(null,arguments)}var Es=(s,a)=>{var t;if(i.isValidElement(s))t=i.cloneElement(s,a);else if(typeof s=="function")t=s(a);else{if(!q(a.x1)||!q(a.y1)||!q(a.x2)||!q(a.y2))return null;t=i.createElement("line",ce({},a,{className:"recharts-reference-line-line"}))}return t},Ls=(s,a,t,n,r,c)=>{var{x:o,width:d}=c,u=r.map(s,{position:t});if(!q(u)||a==="discard"&&!r.isInRange(u))return null;var p=[{x:o+d,y:u},{x:o,y:u}];return n==="left"?p.reverse():p},As=(s,a,t,n,r,c)=>{var{y:o,height:d}=c,u=r.map(s,{position:t});if(!q(u)||a==="discard"&&!r.isInRange(u))return null;var p=[{x:u,y:o+d},{x:u,y:o}];return n==="top"?p.reverse():p},Os=(s,a,t,n)=>{var r=[n.mapWithFallback(s[0],{position:t,fallback:"rangeMin"}),n.mapWithFallback(s[1],{position:t,fallback:"rangeMax"})];return a==="discard"&&r.some(c=>!n.isInRange(c))?null:r},Ps=(s,a,t,n,r,c,o)=>{var{x:d,y:u,segment:p,ifOverflow:m}=o,D=Se(d),f=Se(u);return f?Ls(u,m,n,c,a,t):D?As(d,m,n,r,s,t):p!=null&&p.length===2?Os(p,m,n,new ks({x:s,y:a})):null};function Is(s){var a=ns();return i.useEffect(()=>(a(ls(s)),()=>{a(rs(s))})),null}function $s(s){var{xAxisId:a,yAxisId:t,shape:n,className:r,ifOverflow:c}=s,o=is(),d=cs(),u=le(N=>os(N,a)),p=le(N=>ds(N,t)),m=le(N=>we(N,"xAxis",a,o)),D=le(N=>we(N,"yAxis",t,o)),f=ps();if(!d||!f||u==null||p==null||m==null||D==null)return null;var g=Ps(m,D,f,s.position,u.orientation,p.orientation,s);if(!g)return null;var S=g[0],C=g[1];if(S==null||C==null)return null;var{x:M,y:v}=S,{x:$,y:w}=C,O=c==="hidden"?"url(#".concat(d,")"):void 0,L=Ce(Ce({clipPath:O},us(s)),{},{x1:M,y1:v,x2:$,y2:w}),E=gs({x1:M,y1:v,x2:$,y2:w});return i.createElement(hs,{zIndex:s.zIndex},i.createElement(ms,{className:fs("recharts-reference-line",r)},Es(n,L),i.createElement(xs,ce({},E,{lowerWidth:E.width,upperWidth:E.width}),i.createElement(bs,{label:s.label}),s.children)))}var Rs={ifOverflow:"discard",xAxisId:0,yAxisId:0,fill:"none",label:!1,stroke:"#ccc",fillOpacity:1,strokeWidth:1,position:"middle",zIndex:ts.line};function ie(s){var a=as(s,Rs);return i.createElement(i.Fragment,null,i.createElement(Is,{yAxisId:a.yAxisId,xAxisId:a.xAxisId,ifOverflow:a.ifOverflow,x:a.x,y:a.y,segment:a.segment}),i.createElement($s,a))}ie.displayName="ReferenceLine";const Fs={"one-off":{icon:"ðŸŽ",label:"One-off Deposit",className:"ps-scenario-card--inflow"},"recurring-deposit":{icon:"ðŸ“¥",label:"Recurring Deposit",className:"ps-scenario-card--inflow"},"recurring-withdrawal":{icon:"ðŸ“¤",label:"Recurring Withdrawal",className:"ps-scenario-card--outflow"}};function _s({cashFlow:s,currencyCode:a,onEdit:t,onDelete:n,onToggle:r}){const c=Fs[s.type],o=s.type!=="one-off",d=s.frequency==="annually"?"/ year":"/ month",u=s.amount>0,p=(s.startingValue??0)>0,m=o&&!u&&p;return e.jsxs("div",{className:`ps-scenario-card ${c.className} ${s.enabled?"":"ps-scenario-card--disabled"}`,children:[e.jsxs("div",{className:"ps-scenario-card-actions",children:[e.jsx("button",{className:"ps-scenario-action-btn",onClick:()=>t(s.id),"aria-label":"Edit cash flow",children:"âœï¸"}),e.jsx("button",{className:"ps-scenario-action-btn",onClick:()=>n(s.id),"aria-label":"Delete cash flow",children:"ðŸ—‘ï¸"})]}),e.jsxs("div",{className:"ps-scenario-card-header",children:[e.jsxs("button",{className:`ps-scenario-toggle ${s.enabled?"ps-scenario-toggle--on":""}`,onClick:()=>r(s.id),"aria-label":s.enabled?"Disable cash flow":"Enable cash flow",children:[e.jsx("div",{className:"ps-scenario-toggle-track"}),e.jsx("div",{className:"ps-scenario-toggle-thumb"})]}),e.jsx("span",{className:"ps-scenario-icon",children:c.icon}),e.jsx("span",{className:"ps-scenario-type",children:s.label||c.label})]}),m?e.jsxs("div",{className:"ps-scenario-amount",children:[b(s.startingValue??0,a),e.jsx("span",{className:"ps-scenario-freq",children:" lump sum"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"ps-scenario-amount",children:[b(s.amount,a),o&&e.jsxs("span",{className:"ps-scenario-freq",children:[" ",d]})]}),o&&p&&e.jsxs("div",{className:"ps-scenario-growth",children:[s.type==="recurring-withdrawal"?"Lump at start:":"Starting value:"," ",b(s.startingValue??0,a)]})]}),e.jsx("div",{className:"ps-scenario-dates",children:o?e.jsxs(e.Fragment,{children:[K(s.startDate)," â†’ ",s.endDate?K(s.endDate):"âˆž"]}):K(s.startDate)}),e.jsxs("div",{className:"ps-scenario-growth",children:["Growth: ",s.growthRate,"%"]})]})}const oe="#8b5cf6",W="#10b981",Q="#22d3ee";function Vs({active:s,payload:a,label:t,currencyCode:n}){var c;if(!s||!(a!=null&&a.length))return null;const r=(c=a[0])==null?void 0:c.payload;return r?e.jsxs("div",{className:"ps-tooltip",children:[e.jsx("p",{className:"ps-tooltip-title",children:t}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--p90",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:oe}}),"90th: ",b(r.p90,n)]}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--p75",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:W}}),"75th: ",b(r.p75,n)]}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--median",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:Q}}),"Median: ",b(r.median,n)]}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--p25",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:W}}),"25th: ",b(r.p25,n)]}),e.jsxs("p",{className:"ps-tooltip-row ps-tooltip-row--p10",children:[e.jsx("span",{className:"ps-tooltip-swatch",style:{background:oe}}),"10th: ",b(r.p10,n)]})]}):null}function Ts(s,a=30){if(!s.length)return[];const t=s[0],n=s[s.length-1];if(t===n)return[{binStart:t,binEnd:n,count:s.length,label:""}];const r=(n-t)/a,c=[];for(let o=0;o<a;o++){const d=t+o*r,u=d+r;c.push({binStart:d,binEnd:u,count:0,label:""})}for(const o of s){let d=Math.floor((o-t)/r);d>=a&&(d=a-1),d<0&&(d=0),c[d].count++}for(const o of c){const d=(o.binStart+o.binEnd)/2;d>=1e6?o.label=`${(d/1e6).toFixed(1)}M`:d>=1e3?o.label=`${(d/1e3).toFixed(0)}K`:o.label=String(Math.round(d))}return c}function me(s,a){if(!s.length)return 0;const t=a/100*(s.length-1),n=Math.floor(t),r=Math.ceil(t);return n===r?s[n]:s[n]+(s[r]-s[n])*(t-n)}function Ws({distribution:s,currencyCode:a,hoveredLabel:t}){var d,u,p;const n=i.useMemo(()=>Ts(s,30),[s]),r=i.useMemo(()=>me(s,25),[s]),c=i.useMemo(()=>me(s,50),[s]),o=i.useMemo(()=>me(s,75),[s]);return n.length?e.jsxs("div",{className:"ps-dist-view",children:[e.jsxs("div",{className:"ps-dist-header",children:[e.jsxs("h3",{className:"ps-dist-title",children:["Outcome Distribution â€” ",t||"End of Horizon"]}),e.jsx("p",{className:"ps-dist-subtitle",children:"Each bar shows how many simulations landed in that value range. Highlighted regions mark the key percentiles."})]}),e.jsxs("div",{className:"ps-dist-stats",children:[e.jsxs("div",{className:"ps-dist-stat",children:[e.jsx("span",{className:"ps-dist-stat-label",style:{color:"#eab308"},children:"25th (Pessimistic)"}),e.jsx("span",{className:"ps-dist-stat-value",children:b(Math.round(r),a)})]}),e.jsxs("div",{className:"ps-dist-stat",children:[e.jsx("span",{className:"ps-dist-stat-label",style:{color:Q},children:"Median (Expected)"}),e.jsx("span",{className:"ps-dist-stat-value",children:b(Math.round(c),a)})]}),e.jsxs("div",{className:"ps-dist-stat",children:[e.jsx("span",{className:"ps-dist-stat-label",style:{color:W},children:"75th (Optimistic)"}),e.jsx("span",{className:"ps-dist-stat-value",children:b(Math.round(o),a)})]})]}),e.jsx("div",{className:"ps-chart-container",children:e.jsx(Le,{width:"100%",height:300,children:e.jsxs(ws,{data:n,margin:{top:20,right:10,left:10,bottom:5},children:[e.jsx(Ae,{strokeDasharray:"3 3",stroke:"var(--border-color)",vertical:!1}),e.jsx(Oe,{dataKey:"label",tick:{fill:"var(--text-muted)",fontSize:10},axisLine:{stroke:"var(--border-color)"},tickLine:!1,interval:Math.max(0,Math.floor(n.length/6)-1)}),e.jsx(Pe,{tick:{fill:"var(--text-muted)",fontSize:11},axisLine:!1,tickLine:!1}),e.jsx(Ss,{dataKey:"count",radius:[2,2,0,0],animationDuration:400,children:n.map((m,D)=>{const f=(m.binStart+m.binEnd)/2;let g="rgba(139, 92, 246, 0.5)";return f>=r&&f<=o&&(g="rgba(16, 185, 129, 0.6)"),e.jsx(vs,{fill:g},D)})}),e.jsx(ie,{x:(d=n.find(m=>(m.binStart+m.binEnd)/2>=c))==null?void 0:d.label,stroke:Q,strokeWidth:2,strokeDasharray:"4 4",children:e.jsx(he,{value:"Median",position:"top",fill:Q,fontSize:11})}),e.jsx(ie,{x:(u=n.find(m=>(m.binStart+m.binEnd)/2>=r))==null?void 0:u.label,stroke:"#eab308",strokeWidth:1.5,strokeDasharray:"4 4",children:e.jsx(he,{value:"25th",position:"top",fill:"#eab308",fontSize:10})}),e.jsx(ie,{x:(p=n.find(m=>(m.binStart+m.binEnd)/2>=o))==null?void 0:p.label,stroke:W,strokeWidth:1.5,strokeDasharray:"4 4",children:e.jsx(he,{value:"75th",position:"top",fill:W,fontSize:10})})]})})})]}):null}function zs({data:s,result:a,currencyCode:t}){const[n,r]=i.useState(!1),[c,o]=i.useState(""),d=i.useMemo(()=>s.map(p=>({...p,p10_base:p.p10,band_10_25:Math.max(0,p.p25-p.p10),band_25_75:Math.max(0,p.p75-p.p25),band_75_90:Math.max(0,p.p90-p.p75)})),[s]),u=i.useCallback(p=>{p!=null&&p.activeLabel&&o(p.activeLabel)},[]);return s.length?e.jsxs("div",{className:`ps-flip-container ${n?"ps-flip-container--flipped":""}`,children:[e.jsxs("div",{className:"ps-flip-face ps-flip-face--front",children:[e.jsxs("div",{className:"ps-flip-header",children:[e.jsx("h2",{className:"ps-card-title",children:"Monte Carlo Simulation"}),e.jsx("button",{className:"ps-flip-btn",onClick:()=>r(!0),title:"Show outcome distribution",children:"ðŸ“Š Distribution"})]}),e.jsx("div",{className:"ps-chart-container",children:e.jsx(Le,{width:"100%",height:380,children:e.jsxs(Ns,{data:d,margin:{top:10,right:10,left:10,bottom:0},onMouseMove:u,children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"outerBandGrad",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:oe,stopOpacity:.4}),e.jsx("stop",{offset:"100%",stopColor:oe,stopOpacity:.08})]}),e.jsxs("linearGradient",{id:"innerBandGrad",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:W,stopOpacity:.5}),e.jsx("stop",{offset:"100%",stopColor:W,stopOpacity:.12})]})]}),e.jsx(Ae,{strokeDasharray:"3 3",stroke:"var(--border-color)",vertical:!1}),e.jsx(Oe,{dataKey:"label",tick:{fill:"var(--text-muted)",fontSize:11},axisLine:{stroke:"var(--border-color)"},tickLine:!1,interval:"preserveStartEnd"}),e.jsx(Pe,{tick:{fill:"var(--text-muted)",fontSize:11},axisLine:!1,tickLine:!1,tickFormatter:p=>p>=1e6?`${(p/1e6).toFixed(1)}M`:p>=1e3?`${(p/1e3).toFixed(0)}K`:String(p)}),e.jsx(js,{content:e.jsx(Vs,{currencyCode:t}),cursor:{stroke:"rgba(255,255,255,0.1)"}}),e.jsx(Z,{dataKey:"p10_base",stackId:"bands",stroke:"none",fill:"transparent",legendType:"none",animationDuration:600}),e.jsx(Z,{dataKey:"band_10_25",stackId:"bands",stroke:"none",fill:"url(#outerBandGrad)",name:"10thâ€“90th",animationDuration:600}),e.jsx(Z,{dataKey:"band_25_75",stackId:"bands",stroke:"none",fill:"url(#innerBandGrad)",name:"25thâ€“75th",animationDuration:600}),e.jsx(Z,{dataKey:"band_75_90",stackId:"bands",stroke:"none",fill:"url(#outerBandGrad)",legendType:"none",animationDuration:600}),e.jsx(Z,{dataKey:"median",stroke:Q,strokeWidth:2.5,fill:"none",name:"Median",dot:!1,animationDuration:800}),e.jsx(ys,{wrapperStyle:{fontSize:12,color:"var(--text-secondary)"}})]})})})]}),e.jsxs("div",{className:"ps-flip-face ps-flip-face--back",children:[e.jsx("div",{className:"ps-flip-header",children:e.jsx("button",{className:"ps-flip-btn",onClick:()=>r(!1),title:"Show Monte Carlo chart",children:"ðŸ“ˆ Monte Carlo"})}),e.jsx(Ws,{distribution:a.finalDistribution,currencyCode:t,hoveredLabel:c})]})]}):null}function re(s){const[a,t]=s.split("-").map(Number);return a+(t-1)/12}function Bs(s,a){const t=a-s;let n=1;t>25?n=5:t>12?n=3:t>6&&(n=2);const r=[],c=Math.ceil(s/n)*n;for(let o=c;o<=a;o+=n)r.push(o);return r}const Ie={"one-off":{sign:"+",colorClass:"ps-tl-bar--inflow"},"recurring-deposit":{sign:"+",colorClass:"ps-tl-bar--inflow"},"recurring-withdrawal":{sign:"âˆ’",colorClass:"ps-tl-bar--outflow"}};function $e(s,a){const t=Ie[s.type],n=s.type!=="one-off",r=s.amount>0,c=(s.startingValue??0)>0;if(n&&!r&&c)return`${t.sign}${b(s.startingValue,a)} lump`;const o=s.type==="one-off"?"":s.frequency==="annually"?"/yr":"/mo";return`${t.sign}${b(s.amount,a)}${o}`}function Gs(s,a){const t=[s.label];if(t.push($e(s,a)),s.type!=="one-off"&&(s.startingValue??0)>0){const n=b(s.startingValue,a);t.push(s.type==="recurring-withdrawal"?`Lump: ${n}`:`Starting: ${n}`)}return s.type==="one-off"?t.push(K(s.startDate)):t.push(`${K(s.startDate)} â†’ ${s.endDate?K(s.endDate):"âˆž"}`),t.push(`Growth: ${s.growthRate}%`),t.join(`
`)}function qs({cashFlows:s,simulationEnd:a,currencyCode:t,onEdit:n}){const[r,c]=i.useState(!1);if(s.length===0)return null;const o=I(),d=re(o),u=re(a),p=Math.max(1,u-d),m=Bs(Math.floor(d),Math.ceil(u)),D=[...s].sort((f,g)=>{const S={"one-off":0,"recurring-deposit":1,"recurring-withdrawal":2};return S[f.type]-S[g.type]});return e.jsxs("div",{className:"ps-card ps-tl-card",children:[e.jsx("div",{className:"ps-tl-header",children:e.jsxs("button",{className:"ps-table-toggle",onClick:()=>c(f=>!f),"aria-expanded":r,children:[e.jsx("span",{children:"Timeline"}),e.jsx("span",{className:`ps-table-arrow ${r?"ps-table-arrow--open":""}`,children:"â–¼"})]})}),e.jsx("div",{className:`ps-tl-body ${r?"ps-tl-body--open":""}`,children:e.jsxs("div",{className:"ps-tl-content",children:[e.jsx("div",{className:"ps-tl-rows",children:D.map(f=>{const g=Ie[f.type],S=re(f.startDate),C=f.endDate?re(f.endDate):S,M=Math.max(0,(S-d)/p*100),v=(C-S)/p*100,$=Math.max(5,v),w=Math.min($,100-M),O=w<18,L=$e(f,t);return e.jsx("div",{className:"ps-tl-row",title:Gs(f,t),children:e.jsx("div",{className:`ps-tl-bar ${g.colorClass} ${f.enabled?"":"ps-tl-bar--disabled"} ${n?"ps-tl-bar--clickable":""}`,style:{left:`${M}%`,width:`${w}%`},onClick:n?()=>n(f.id):void 0,role:n?"button":void 0,tabIndex:n?0:void 0,onKeyDown:n?E=>{(E.key==="Enter"||E.key===" ")&&n(f.id)}:void 0,children:O?e.jsx("span",{className:"ps-tl-bar-amount",children:L}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"ps-tl-bar-label",children:f.label}),e.jsx("span",{className:"ps-tl-bar-amount",children:L})]})})},f.id)})}),e.jsx("div",{className:"ps-tl-axis",children:m.map(f=>{const g=(f-d)/p*100;return e.jsx("span",{className:"ps-tl-axis-label",style:{left:`${g}%`},children:f},f)})})]})})]})}function T(s,a){const[t,n]=s.split("-").map(Number),r=t*12+(n-1)+a,c=Math.floor(r/12),o=r%12+1;return`${c}-${String(o).padStart(2,"0")}`}function Me(){try{const s=localStorage.getItem("vibe-finance-sim-default-years"),a=Number(s);if(!Number.isNaN(a))return Math.min(60,Math.max(5,Math.round(a)))}catch{}return 35}function De({value:s,onChange:a,symbol:t,ariaLabel:n}){const[r,c]=i.useState(s.toLocaleString("en-GB"));i.useEffect(()=>{c(s.toLocaleString("en-GB"))},[s]);const o=()=>{const d=Number(r.replace(/,/g,""));isNaN(d)?c(s.toLocaleString("en-GB")):a(d)};return e.jsxs("div",{className:"ps-currency-input",children:[e.jsx("span",{className:"ps-currency-prefix",children:t}),e.jsx("input",{type:"text",inputMode:"numeric",value:r,onChange:d=>c(d.target.value),onBlur:o,"aria-label":n})]})}function Re({value:s,onChange:a,suffix:t,ariaLabel:n,min:r=0,max:c}){const[o,d]=i.useState(String(s));i.useEffect(()=>{d(String(s))},[s]);const u=()=>{let p=Number(o);if(isNaN(p)){d(String(s));return}r!==void 0&&(p=Math.max(r,p)),c!==void 0&&(p=Math.min(c,p)),a(p)};return e.jsxs("div",{className:"ps-numeric-input",children:[e.jsx("input",{type:"text",inputMode:"decimal",value:o,onChange:p=>d(p.target.value),onBlur:u,"aria-label":n}),t&&e.jsx("span",{className:"ps-numeric-suffix",children:t})]})}function fe({value:s,onChange:a,ariaLabel:t}){return e.jsx("input",{type:"month",className:"ps-month-input",value:s,onChange:n=>a(n.target.value),"aria-label":t})}function Ks({initial:s,currencySymbol:a,savedLabels:t,onSave:n,onCancel:r,onDirtyChange:c,onRegisterSubmit:o,onLabelSaved:d,onLabelDeleted:u}){const p=!!s,[m,D]=i.useState((s==null?void 0:s.type)??"recurring-deposit"),[f,g]=i.useState((s==null?void 0:s.label)??""),[S,C]=i.useState(!1),M=i.useRef(null),[v,$]=i.useState((s==null?void 0:s.amount)??0),[w,O]=i.useState((s==null?void 0:s.startingValue)??0),[L,E]=i.useState((s==null?void 0:s.growthRate)??5),[N,V]=i.useState((s==null?void 0:s.startDate)??I()),[_,Y]=i.useState((s==null?void 0:s.endDate)??T(I(),180)),[R,H]=i.useState((s==null?void 0:s.frequency)??"monthly"),[de,F]=i.useState(!1);i.useEffect(()=>{p||(g(""),$(0),O(0),E(5),V(I()),Y(T(I(),180)),H("monthly"))},[m,p]);const j=m!=="one-off",P=i.useMemo(()=>s?{type:s.type,label:s.label??"",amount:s.amount,startingValue:s.startingValue??0,growthRate:s.growthRate,startDate:s.startDate,endDate:s.endDate??T(I(),180),frequency:s.frequency??"monthly"}:{type:m,label:"",amount:0,startingValue:0,growthRate:5,startDate:I(),endDate:T(I(),180),frequency:"monthly"},[s,m]),ee=i.useMemo(()=>{const y=m!==P.type||f!==P.label||v!==P.amount||L!==P.growthRate||N!==P.startDate;return j?y||w!==P.startingValue||_!==P.endDate||R!==P.frequency:y},[m,f,v,L,N,j,w,_,R,P]);i.useEffect(()=>{c==null||c(ee)},[ee,c]),i.useEffect(()=>()=>{c==null||c(!1)},[c]);const U=()=>{if(j&&v<=0&&w<=0){F(!0);return}if(!j&&v<=0){F(!0);return}const y=f||(m==="one-off"?"One-off":m==="recurring-deposit"?"Deposit":"Withdrawal");f.trim()&&(d==null||d(f.trim())),n({id:(s==null?void 0:s.id)??Ee(),type:m,label:y,amount:v,startingValue:j?w:void 0,growthRate:L,startDate:N,endDate:j?_:void 0,frequency:j?R:void 0,enabled:(s==null?void 0:s.enabled)??!0})};return i.useEffect(()=>(o==null||o(U),()=>o==null?void 0:o(null)),[o,U]),e.jsxs("div",{className:"ps-scenario-form",children:[e.jsx("h3",{className:"ps-form-title",children:p?"Edit Cash Flow":"New Cash Flow"}),!p&&e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"Type"}),e.jsxs("div",{className:"ps-type-selector",children:[e.jsx("button",{className:`ps-type-btn ps-type-btn--inflow ${m==="recurring-deposit"?"ps-type-btn--active":""}`,onClick:()=>D("recurring-deposit"),children:"ðŸ“¥ Deposit"}),e.jsx("button",{className:`ps-type-btn ps-type-btn--outflow ${m==="recurring-withdrawal"?"ps-type-btn--active":""}`,onClick:()=>D("recurring-withdrawal"),children:"ðŸ“¤ Withdrawal"}),e.jsx("button",{className:`ps-type-btn ps-type-btn--inflow ${m==="one-off"?"ps-type-btn--active":""}`,onClick:()=>D("one-off"),children:"ðŸŽ One-off"})]})]}),e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"Label"}),e.jsxs("div",{className:"ps-label-combo",children:[e.jsx("input",{ref:M,type:"text",className:"ps-text-input",value:f,onChange:y=>{g(y.target.value),C(!0)},onFocus:()=>C(!0),onBlur:()=>{setTimeout(()=>C(!1),150)},placeholder:"e.g. Inheritance, Pension, Salary...","aria-label":"Cash flow label"}),S&&t.length>0&&e.jsx("div",{className:"ps-label-dropdown",children:t.filter(y=>!f||y.toLowerCase().includes(f.toLowerCase())).map(y=>e.jsxs("div",{className:"ps-label-dropdown-item",children:[e.jsx("button",{className:"ps-label-dropdown-pick",onMouseDown:z=>{z.preventDefault(),g(y),C(!1)},children:y}),e.jsx("button",{className:"ps-label-dropdown-del",onMouseDown:z=>{z.preventDefault(),u==null||u(y)},"aria-label":`Remove ${y}`,children:"Ã—"})]},y))})]})]}),j&&e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:m==="recurring-withdrawal"?"Lump Withdrawal":"Starting Value"}),e.jsx(De,{value:w,onChange:O,symbol:a,ariaLabel:m==="recurring-withdrawal"?"Lump withdrawal amount":"Starting value amount"})]}),e.jsxs("div",{className:"ps-field",children:[e.jsxs("label",{className:"ps-label",children:["Amount",j?` (${R==="monthly"?"per month":"per year"})`:""]}),e.jsx(De,{value:v,onChange:$,symbol:a,ariaLabel:"Cash flow amount"})]}),j&&e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"Frequency"}),e.jsxs("div",{className:"ps-toggle",children:[e.jsx("button",{className:`ps-toggle-btn ${R==="monthly"?"ps-toggle-btn--active":""}`,onClick:()=>H("monthly"),children:"Monthly"}),e.jsx("button",{className:`ps-toggle-btn ${R==="annually"?"ps-toggle-btn--active":""}`,onClick:()=>H("annually"),children:"Annually"})]})]}),e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:j?"Start Date":"Date"}),e.jsx(fe,{value:N,onChange:V,ariaLabel:"Start date"})]}),j&&e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"End Date"}),e.jsx(fe,{value:_,onChange:Y,ariaLabel:"End date"})]}),e.jsxs("div",{className:"ps-field",children:[e.jsx("label",{className:"ps-label",children:"Annual Growth Rate"}),e.jsx(Re,{value:L,onChange:E,suffix:"%",ariaLabel:"Annual growth rate",min:0,max:50})]}),e.jsxs("div",{className:"ps-form-actions",children:[e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:r,children:"Cancel"}),e.jsx("button",{className:"ps-btn ps-btn--primary",onClick:U,children:p?"Save Changes":"Add Cash Flow"})]}),de&&e.jsx("div",{className:"confirm-overlay",onClick:()=>F(!1),children:e.jsxs("div",{className:"confirm-dialog ps-empty-warning",onClick:y=>y.stopPropagation(),children:[e.jsx("div",{className:"ps-empty-warning-icon",children:"âš ï¸"}),e.jsx("p",{className:"confirm-message",children:j?"Please enter a periodic amount or a lump sum before saving.":"Please enter an amount before saving."}),e.jsx("div",{className:"confirm-actions",children:e.jsx("button",{className:"confirm-btn confirm-btn--save",onClick:()=>F(!1),children:"Got it"})})]})})]})}function Zs(){const{currency:s}=Ue(),{user:a}=Xe(),[t,n]=G("vf-ps-sim-end",()=>T(I(),Me()*12)),[r,c]=G("vf-ps-cash-flows",[]),[o,d]=G("vf-ps-scenarios",[]),[u,p]=G("vf-ps-active-id",null),[m,D]=i.useState("all"),[f]=i.useState(12),g=500,[S,C]=i.useState(!1),[M,v]=i.useState(null),[$,w]=i.useState(!1),O=i.useRef(null),L=i.useRef(null),E=i.useRef(null),[N,V]=i.useState(null),[_,Y]=G("vf-ps-horizon-mode","years"),[R,H]=i.useState(!1),[de,F]=i.useState(!1),{gate:j,showLogin:P,onLoginSuccess:ee,onLoginClose:U}=Je(),[y,z]=i.useState(!1),[X,xe]=i.useState(""),[Fe,se]=i.useState(!1),[J,be]=i.useState(""),[_e,ge]=G("vf-ps-labels",[]),k=o.find(l=>l.id===u)??null,pe=i.useMemo(()=>k?k.simulationEnd!==t||JSON.stringify(k.cashFlows)!==JSON.stringify(r):r.length>0,[k,t,r]);i.useEffect(()=>{if(!a)return;let l=!1;return z(!0),Ze(a.uid).then(h=>{l||h.length>0&&d(h)}).catch(h=>console.error("[scenarios] fetch failed:",h)).finally(()=>{l||z(!1)}),()=>{l=!0}},[a,d]);const A=i.useMemo(()=>r.length===0?null:ss({startingBalance:0,cashFlows:r,volatility:f,numPaths:g,endOverride:t}),[r,f,g,t]),je=i.useCallback(l=>{j(()=>{const h={id:Ee(),name:l,startingBalance:0,simulationEnd:t,cashFlows:[...r]};d(x=>[...x,h]),p(h.id),a&&ue(a.uid,h).catch(x=>console.error("[scenarios] save-as failed:",x))})},[a,j,t,r,d,p]),Ve=i.useCallback(()=>{u&&j(()=>{const l={id:u,name:(k==null?void 0:k.name)??"Scenario",startingBalance:0,simulationEnd:t,cashFlows:[...r]};d(h=>h.map(x=>x.id===u?l:x)),a&&ue(a.uid,l).catch(h=>console.error("[scenarios] save failed:",h))})},[a,j,u,k,t,r,d]),Te=i.useCallback(l=>{const h=o.find(x=>x.id===l);h&&(p(l),n(h.simulationEnd),c(h.cashFlows))},[o,p,n,c]),ae=i.useCallback(()=>{p(null),n(T(I(),Me()*12)),c([]),C(!1),v(null)},[p,n,c]),We=i.useCallback(l=>{d(h=>h.filter(x=>x.id!==l)),a&&Qe(a.uid,l).catch(h=>console.error("[scenarios] delete failed:",h)),u===l&&ae()},[a,u,d,ae]),ve=i.useCallback(l=>{if(!(!u||!l.trim())){if(d(h=>h.map(x=>x.id===u?{...x,name:l.trim()}:x)),a){const h=o.find(x=>x.id===u);h&&ue(a.uid,{...h,name:l.trim()}).catch(x=>console.error("[scenarios] rename failed:",x))}se(!1)}},[a,u,o,d]),te=i.useCallback(()=>{setTimeout(()=>{var l;(l=L.current)==null||l.scrollIntoView({behavior:"smooth",block:"start"})},50)},[]),ne=i.useCallback(l=>{const h=r.find(x=>x.id===l);h&&(w(!1),v(h),C(!0),te())},[r,te]),ze=i.useCallback(()=>{w(!1),v(null),C(!0),te()},[te]),Ne=i.useCallback(l=>{if(!(S&&(M==null?void 0:M.id)===l)){if(S&&$){V(l);return}ne(l)}},[S,M,$,ne]),Be=i.useCallback(()=>{var l;E.current=N,V(null),(l=O.current)==null||l.call(O)},[N]),Ge=i.useCallback(()=>{const l=N;V(null),l&&ne(l)},[N,ne]),ye=i.useCallback(()=>{V(null)},[]),qe=i.useCallback(l=>{c(h=>h.filter(x=>x.id!==l))},[c]),Ke=i.useCallback(l=>{c(h=>h.map(x=>x.id===l?{...x,enabled:!x.enabled}:x))},[c]),Ye=i.useCallback(l=>{c(M?x=>x.map(B=>B.id===l.id?l:B):x=>[...x,l]),w(!1);const h=E.current;if(h){E.current=null;const x=r.find(B=>B.id===h);if(x){v(x);return}}C(!1),v(null)},[M,c,r]),He=i.useCallback(()=>{w(!1),C(!1),v(null)},[]);return e.jsxs("div",{className:"ps-page",children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{className:"page-title",children:"Portfolio Simulator"}),e.jsx("p",{className:"page-subtitle",children:"Simulate your financial future with Monte Carlo analysis."})]}),e.jsxs("div",{className:"ps-grid",children:[e.jsxs("div",{className:"ps-left",children:[e.jsxs("div",{className:"ps-card ps-scn-card",children:[e.jsxs("div",{className:"ps-scn-header",children:[e.jsx("h2",{className:"ps-card-title",children:"ðŸ“‹ Scenario"}),k&&!pe&&e.jsx("span",{className:"ps-scn-badge ps-scn-badge--saved",children:"Saved"}),pe&&e.jsx("span",{className:"ps-scn-badge ps-scn-badge--dirty",children:"Unsaved"})]}),o.length>0&&e.jsxs("select",{className:"ps-scn-select",value:u??"",onChange:l=>l.target.value?Te(l.target.value):ae(),children:[e.jsx("option",{value:"",children:"â€” New scenario â€”"}),o.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]}),de?e.jsxs("div",{className:"ps-scn-save-row",children:[e.jsx("input",{className:"ps-text-input",placeholder:"Scenario nameâ€¦",value:X,onChange:l=>xe(l.target.value),onKeyDown:l=>{l.key==="Enter"&&X.trim()&&(je(X.trim()),F(!1)),l.key==="Escape"&&F(!1)},autoFocus:!0}),e.jsx("button",{className:"ps-btn ps-btn--primary",disabled:!X.trim(),onClick:()=>{je(X.trim()),F(!1)},children:"Save"}),e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:()=>F(!1),children:"Cancel"})]}):Fe?e.jsxs("div",{className:"ps-scn-save-row",children:[e.jsx("input",{className:"ps-text-input",placeholder:"New nameâ€¦",value:J,onChange:l=>be(l.target.value),onKeyDown:l=>{l.key==="Enter"&&J.trim()&&ve(J),l.key==="Escape"&&se(!1)},autoFocus:!0}),e.jsx("button",{className:"ps-btn ps-btn--primary",disabled:!J.trim(),onClick:()=>ve(J),children:"Rename"}),e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:()=>se(!1),children:"Cancel"})]}):e.jsxs("div",{className:"ps-scn-actions",children:[u&&pe&&e.jsx("button",{className:"ps-btn ps-btn--primary",onClick:Ve,children:"ðŸ’¾ Save"}),e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:()=>{F(!0),xe(k!=null&&k.name?`${k.name} copy`:"")},children:"Save asâ€¦"}),e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:ae,children:"+ New"}),u&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"ps-btn ps-btn--secondary",onClick:()=>{se(!0),be((k==null?void 0:k.name)??"")},children:"âœï¸"}),e.jsx("button",{className:"ps-btn ps-btn--secondary ps-btn--danger",onClick:()=>We(u),children:"ðŸ—‘ï¸"})]})]}),!a&&e.jsx("button",{className:"ps-login-prompt",onClick:()=>j(()=>{}),children:"ðŸ”’ Sign in to save scenarios to your account"}),y&&e.jsx("div",{className:"ps-sync-indicator",children:"Syncingâ€¦"})]}),e.jsxs("div",{className:"ps-card",children:[e.jsx("h2",{className:"ps-card-title",children:"Simulation Setup"}),e.jsxs("div",{className:"ps-field",children:[e.jsxs("div",{className:"ps-label-row",children:[e.jsx("label",{className:"ps-label",children:"Horizon"}),e.jsxs("div",{className:"ps-toggle ps-toggle--sm",children:[e.jsx("button",{className:`ps-toggle-btn ${_==="years"?"ps-toggle-btn--active":""}`,onClick:()=>Y("years"),children:"Years"}),e.jsx("button",{className:`ps-toggle-btn ${_==="date"?"ps-toggle-btn--active":""}`,onClick:()=>Y("date"),children:"Date"})]})]}),_==="years"?e.jsx(Re,{value:(()=>{const[l,h]=t.split("-").map(Number),x=new Date,B=l*12+h-(x.getFullYear()*12+(x.getMonth()+1));return Math.max(1,Math.round(B/12))})(),onChange:l=>n(T(I(),Math.round(l*12))),suffix:"years",ariaLabel:"Simulation horizon in years",min:1,max:100}):e.jsx(fe,{value:t,onChange:n,ariaLabel:"Simulation end date"})]}),e.jsx("button",{className:"ps-btn ps-btn--gold ps-btn--full",onClick:ze,children:"+ Add Cash Flow"})]}),S&&e.jsx("div",{className:"ps-card ps-card--form",ref:L,children:e.jsx(Ks,{initial:M??void 0,currencySymbol:s.symbol,savedLabels:_e,onSave:Ye,onCancel:He,onDirtyChange:w,onRegisterSubmit:l=>{O.current=l},onLabelSaved:l=>ge(h=>h.includes(l)?h:[...h,l].sort()),onLabelDeleted:l=>ge(h=>h.filter(x=>x!==l))})}),r.length>0&&e.jsxs("div",{className:"ps-card",children:[e.jsxs("h2",{className:"ps-card-title",children:["Cash Flows",e.jsx("span",{className:"ps-scenario-count",children:r.length})]}),e.jsx("div",{className:"ps-filter",children:["all","deposits","withdrawals"].map(l=>e.jsx("button",{className:`ps-filter-btn ${m===l?"ps-filter-btn--active":""}`,onClick:()=>D(l),children:l==="all"?"All":l==="deposits"?"ðŸ“¥ Deposits":"ðŸ“¤ Withdrawals"},l))}),e.jsx("div",{className:"ps-scenario-list",children:r.filter(l=>m==="all"?!0:m==="deposits"?l.type!=="recurring-withdrawal":l.type==="recurring-withdrawal").map(l=>e.jsx(_s,{cashFlow:l,currencyCode:s.code,onEdit:Ne,onDelete:qe,onToggle:Ke},l.id))})]})]}),e.jsxs("div",{className:"ps-right",children:[A&&e.jsxs("div",{className:"ps-card ps-results-card",children:[e.jsx("h2",{className:"ps-card-title",children:"Results"}),e.jsxs("div",{className:"ps-results-grid",children:[e.jsxs("div",{className:"ps-result-item",children:[e.jsx("span",{className:"ps-result-label",children:"Median (Expected)"}),e.jsx("span",{className:"ps-result-value ps-result-value--cyan",children:b(A.finalMedian,s.code)})]}),e.jsxs("div",{className:"ps-result-item",children:[e.jsx("span",{className:"ps-result-label",children:"Optimistic (75th)"}),e.jsx("span",{className:"ps-result-value ps-result-value--green",children:b(A.finalP75,s.code)})]}),e.jsxs("div",{className:"ps-result-item",children:[e.jsx("span",{className:"ps-result-label",children:"Pessimistic (25th)"}),e.jsx("span",{className:"ps-result-value ps-result-value--yellow",children:b(A.finalP25,s.code)})]})]})]}),A&&A.timeSteps.length>0&&e.jsx("div",{className:"ps-card ps-chart-card",children:e.jsx(zs,{data:A.timeSteps,result:A,currencyCode:s.code})}),r.length>0&&e.jsx(qs,{cashFlows:r,simulationEnd:t,currencyCode:s.code,onEdit:Ne}),A&&A.timeSteps.length>0&&e.jsxs("div",{className:"ps-card ps-table-card",children:[e.jsx("div",{className:"ps-table-header",children:e.jsxs("button",{className:"ps-table-toggle",onClick:()=>H(l=>!l),"aria-expanded":R,children:[e.jsx("span",{children:"Table"}),e.jsx("span",{className:`ps-table-arrow ${R?"ps-table-arrow--open":""}`,children:"â–¼"})]})}),e.jsx("div",{className:`ps-table-body ${R?"ps-table-body--open":""}`,children:e.jsx("div",{className:"ps-table-scroll",children:e.jsxs("table",{className:"ps-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"ps-th ps-th--left",children:"Year"}),e.jsx("th",{className:"ps-th ps-th--right",children:"10th"}),e.jsx("th",{className:"ps-th ps-th--right",children:"25th"}),e.jsx("th",{className:"ps-th ps-th--right",children:"Median"}),e.jsx("th",{className:"ps-th ps-th--right",children:"75th"}),e.jsx("th",{className:"ps-th ps-th--right",children:"90th"})]})}),e.jsx("tbody",{children:A.timeSteps.map((l,h)=>e.jsxs("tr",{className:"ps-tr",children:[e.jsx("td",{className:"ps-td ps-td--left",children:l.label}),e.jsx("td",{className:"ps-td ps-td--right",children:b(l.p10,s.code)}),e.jsx("td",{className:"ps-td ps-td--right",children:b(l.p25,s.code)}),e.jsx("td",{className:"ps-td ps-td--right ps-td--accent",children:b(l.median,s.code)}),e.jsx("td",{className:"ps-td ps-td--right",children:b(l.p75,s.code)}),e.jsx("td",{className:"ps-td ps-td--right",children:b(l.p90,s.code)})]},h))})]})})})]}),!A&&e.jsxs("div",{className:"ps-card ps-empty-card",children:[e.jsx("div",{className:"ps-empty-icon",children:"ðŸ“Š"}),e.jsx("h2",{className:"ps-empty-title",children:"No Simulation Yet"}),e.jsx("p",{className:"ps-empty-text",children:"Add some cash flows to see your Monte Carlo simulation."})]})]})]}),N&&e.jsx("div",{className:"confirm-overlay",onClick:ye,children:e.jsxs("div",{className:"confirm-dialog",onClick:l=>l.stopPropagation(),children:[e.jsx("p",{className:"confirm-message",children:"You have unsaved changes"}),e.jsxs("div",{className:"confirm-actions",children:[e.jsx("button",{className:"confirm-btn confirm-btn--cancel",onClick:ye,children:"Cancel"}),e.jsx("button",{className:"confirm-btn confirm-btn--discard",onClick:Ge,children:"Discard"}),e.jsx("button",{className:"confirm-btn confirm-btn--save",onClick:Be,children:"Save"})]})]})}),P&&e.jsx(es,{onClose:U,onSuccess:ee})]})}export{Zs as PortfolioSimulatorPage};
